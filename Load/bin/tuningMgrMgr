#!/usr/bin/perl

use strict;
use lib "$ENV{GUS_HOME}/lib/perl";
use Data::Dumper;
use XML::Simple;
use DBI;
use Getopt::Long qw(GetOptions);
use ApiCommonData::Load::TuningConfig::TuningRegistry;

my ($help, $propFile, $connectName, $password, $instanceNickname, $family, $svn);

my $subcommand = $ARGV[0];

GetOptions("propFile=s" => \$propFile,
           "connectName=s" => \$connectName,
           "password=s" => \$password,
           "instanceNickname=s" => \$instanceNickname,
           "family=s" => \$family,
           "svn=s" => \$svn,
	  );

my $badUsage;

if ($subcommand ne "addinstance" && $subcommand ne "removeinstance"
    && $subcommand ne "list" && $subcommand ne "changesvn"&& $subcommand ne "archiveinstance" && $subcommand ne "unarchiveinstance") {
  print STDERR "ERROR: Illegal Subcommand \"$subcommand\".  Should be one of [addinstance|removeinstance|list|changesvn]\n";
  $badUsage = 1;
}

if ($subcommand && !$propFile && !$password) {
  print STDERR "ERROR: The \"$subcommand\" subcommand requires either \"-propFile\" or \"-password\" parameter\n";
  $badUsage = 1;
}

if ($subcommand && $subcommand ne "list" && $subcommand ne "changesvn" && !$connectName && !$instanceNickname) {
  print STDERR "ERROR: the \"$subcommand\" subcommand requires either \"-connectname\" or \"-instanceNickname\" parameter\n";
  $badUsage = 1;
}

if ($subcommand && $subcommand ne "list" && $subcommand ne "addinstance" && $subcommand ne "changesvn" && !$connectName && !$instanceNickname) {
  print STDERR "ERROR: the \"$subcommand\" subcommand requires either \"-connectname\" or \"-instanceNickname\" parameter\n";
  $badUsage = 1;
}

if ($subcommand eq "changesvn" && !$svn) {
  print STDERR "ERROR: the \"$subcommand\" subcommand requires the \"-svn\" parameter\n";
  $badUsage = 1;
}

if ($subcommand eq "changesvn" && !$family) {
  print STDERR "ERROR: the \"$subcommand\" subcommand requires the \"-family\" parameter\n";
  $badUsage = 1;
}

if ($subcommand eq "addinstance") {
  if (!$connectName) {
    print STDERR "ERROR: the \"$subcommand\" subcommand requires the \"-connectName\" parameter\n";
    $badUsage = 1;
  }

  if (!$instanceNickname) {
    print STDERR "ERROR: the \"$subcommand\" subcommand requires the \"-instanceNickname\" parameter\n";
    $badUsage = 1;
  }

  if (!$family) {
    print STDERR "ERROR: the \"$subcommand\" subcommand requires the \"-family\" parameter\n";
    $badUsage = 1;
  }
}

if ($badUsage) {
  usage();
  die;
}

my $dblink = "\@prodS.login_comment";
if (!$connectName) {
  $connectName = "apicommS";
  $dblink = "";
}

my $dbh = getDbHandle($connectName, $propFile, $password);

list($dbh, $dblink) if $subcommand eq "list";
addInstance($dbh, $instanceNickname, $family, $svn)
  if $subcommand eq "addinstance";
removeInstance($dbh, $dblink, $instanceNickname)
  if $subcommand eq "removeinstance";
changeSvn($dbh, $dblink, $family, $svn)
  if $subcommand eq "changesvn";
archive($dbh, $dblink, $instanceNickname, 1)
  if $subcommand eq "archiveinstance";
archive($dbh, $dblink, $instanceNickname, 0)
  if $subcommand eq "unarchiveinstance";

###############################################################################

sub usage {
  ApiCommonData::Load::TuningConfig::Log::addLog(
q{
Usage:

tuningMgrMgr addinstance -connectName=s -instanceNickname=s -family=s [-svn=s] [-password=s | -propFile <FILE>]
tuningMgrMgr removeinstance [-connectName=s | -instanceNickname=s] [-password=s | -propFile <FILE>]
tuningMgrMgr list [-password=s | -propFile <FILE>]
tuningMgrMgr changesvn -family=s -svn=s [-password=s | -propFile <FILE>]
tuningMgrMgr [archiveinstance | unarchiveinstance] -connectName=s

options:
  propFile         pathname of a file containing database username and password, as with tuningManager
  connectName      tnsping name to use to connect to database
  instanceNickname unique name to identify instance in registry and in email subject-lines
  family           name of family of instances (e.g. "toxo440") to which this instance belongs
  password         database login password
  svn              Subversion trunk/branch info, e.g. "trunk" or "branches/api-aug-08"

Sample prop file:
<tuningProps>
  <password>JoeSentMe</password>
  <username>apidb</username>
</tuningProps>
});
}


sub getDbHandle {
  my ($instance, $propFile, $password) = @_;
  my $username = 'apidb';

  if ($propFile) {
    my $simple = XML::Simple->new();
    my $props = $simple->XMLin($propFile);
    $password = $props->{password} if !$password;
    $username = $props->{username} if $props->{username};
  }

  my $dsn = "dbi:Oracle:" . $instance;

  my $dbh = DBI->connect(
                $dsn,
                $username,
                $password,
                { PrintError => 1, RaiseError => 0}
                ) or die "Can't connect to the database: $DBI::errstr\n";
  $dbh->{LongReadLen} = 1000000;
  $dbh->{LongTruncOk} = 1;
  return $dbh;
}

sub list {
  my ($dbh, $dblink) = @_;

  my $stmt = $dbh->prepare(<<SQL);
      select ti.instance_nickname,
             replace(replace(tf.subversion_url, 'https://www.cbil.upenn.edu/svn/apidb/ApiCommonData/', ''), '/Load/lib/xml', ''),
             ti.family_name,
             case
               when last_ok is null
                 then '(null)'
               when sysdate - last_ok < 1
                 then to_char(last_ok, 'yy-mon-dd hh24:mi') || ' (' || round( (sysdate - last_ok) * 24) || ' hours ago)'
                 else to_char(last_ok, 'yy-mon-dd hh24:mi') || ' (' || round(sysdate - last_ok) || ' days ago)'
             end as last_ok,
             case
               when outdated_since is null
                 then '(null)'
               when sysdate - outdated_since < 1
                 then to_char(outdated_since, 'yy-mon-dd hh24:mi') || ' (' || round( (sysdate - outdated_since) * 24) || ' hours ago)'
                 else to_char(outdated_since, 'yy-mon-dd hh24:mi') || ' (' || round(sysdate - outdated_since) || ' days ago)'
             end as outdated_since
      from apidb_r.TuningInstance$dblink ti, apidb_r.TuningFamily$dblink tf
      where (ti.archived is null or ti.archived = 0) and
            ti.family_name = tf.family_name(+)
      order by ti.family_name, ti.instance_nickname
SQL

  $stmt->execute()
    or print STDERR $dbh->errstr;

  my $printedSomething;
  my $lastFamily = 'gambino';
  my $instanceCount;
  while (my ($nickname, $svn, $family, $lastCheck, $lastUpdate) = $stmt->fetchrow_array()) {
    $instanceCount++;

    print "\n---------family--------- ---instance_nickname----- ---subversion------------ -- last OK --------------------- -- out-of-date since ---------\n"
      if !$printedSomething;

    $printedSomething = 1;

# This changes the "family" and "svn" fields to double-quotes ("dittoes") when
# they're the same as the previous value.  This isn't so good when you want to
# grep out a single instance.
#
#    if ($family eq $lastFamily) {
#      $family = "   \"     ";
#      $svn = "   \"     ";
#    } else {
#      $lastFamily = $family;
#    }

    printf "%-24s %-25s %-25s %-32s %-32s\n", $family, $nickname, $svn, $lastCheck, $lastUpdate;
  }
  $stmt->finish();

  printf "\n%d instance" . ($instanceCount == 1 ? '' : 's') . " configured\n\n", $instanceCount;
}

sub addInstance {
  my ($dbh, $instanceNickname, $family, $svn) = @_;

  # find out whether this family exists
  my $stmt = $dbh->prepare(<<SQL);
      select replace(replace(subversion_url, 'https://www.cbil.upenn.edu/svn/apidb/ApiCommonData/', ''), '/Load/lib/xml', '')
      from apidb_r.TuningFamily\@apidb.login_comment
      where family_name = '$family'
SQL

  $stmt->execute()
    or print STDERR $dbh->errstr;
  my ($existingSvn) = $stmt->fetchrow_array();
  $stmt->finish();

  if ($svn && $existingSvn && $svn ne $existingSvn) {
    # update to new svn
    print "Changing svn configuration from \"$existingSvn\" to \"$svn\" for family \"$family\"\n";
    my $url = svnUrl($svn);
    $dbh->do(<<SQL) or die $dbh->errstr;
      update apidb_r.TuningFamily\@apidb.login_comment
      set subversion_url = '$url'
      where family_name = '$family'
SQL
  } elsif ($svn && !$existingSvn) {
    # insert new family
      my $url = svnUrl($svn);
      $dbh->do(<<SQL) or die $dbh->errstr;
        insert into apidb_r.TuningFamily\@apidb.login_comment (family_name, subversion_url, notify_emails, is_live)
        values ('$family', '$url',
                'TuningMgr\@pcbi.upenn.edu', 1)
SQL
  } elsif (!$svn && !$existingSvn) {
    # new family, but subversion config not supplied
    die "ERROR: Subversion setting (e.g. \"trunk\" or \"branches/api-aug-08\") must be specified (using \"-svn\" parameter) for new family \"$family\"\n"
  }

  # remove old InstanceMetaInfo
  $dbh->do("delete from apidb.InstanceMetaInfo")
    or die $dbh->errstr;

  # add new InstanceMetaInfo
  $dbh->do("insert into apidb.InstanceMetaInfo (instance_nickname) values ('$instanceNickname')")
    or die $dbh->errstr;

  # insert new TuningInstance
  $dbh->do(<<SQL) or die $dbh->errstr;
      insert into apidb_r.TuningInstance\@apidb.login_comment
          (instance_nickname, family_name)
      values ('$instanceNickname', '$family')
SQL
}

sub removeInstance {
  my ($dbh, $dblink, $instanceNickname) = @_;

  # get instanceNickname from InstanceMetaInfo, if not supplied
  if (!$instanceNickname) {
    my $stmt = $dbh->prepare("select instance_nickname from apidb.InstanceMetaInfo");
    $stmt->execute() or print STDERR $dbh->errstr;
    ($instanceNickname) = $stmt->fetchrow_array();
    $stmt->finish();
  }

  # get family name
  my $stmt = $dbh->prepare(<<SQL);
    select family_name from apidb_r.TuningInstance$dblink
    where instance_nickname = '$instanceNickname'
SQL
  $stmt->execute() or print STDERR $dbh->errstr;
  my ($family) = $stmt->fetchrow_array();
  $stmt->finish();

  # remove instance
  my $rowCount = $dbh->do(<<SQL) or die $dbh->errstr;
    delete from apidb_r.TuningInstance$dblink
    where instance_nickname = '$instanceNickname'
SQL

  printf "removed %d " . ($rowCount == 1 ? "instance" : "instances") . ", nicknamed \"$instanceNickname\", from the family \"$family\"\n", $rowCount;

  # is this the last member of the family?
  my $stmt = $dbh->prepare("select count(*) from apidb_r.TuningInstance$dblink where family_name = '$family'");
  $stmt->execute() or print STDERR $dbh->errstr;
  my ($familyCount) = $stmt->fetchrow_array();
  $stmt->finish();

  # if so, remove the family
  if (!$familyCount) {
    $dbh->do("delete from apidb_r.TuningFamily$dblink where family_name = '$family'")
      or die $dbh->errstr;
  }
}

sub changeSvn {
   my ($dbh, $dblink, $family, $svn) = @_;

   # set svn, based on family
   my $url = svnUrl($svn);
   my $familyCount = $dbh->do(<<SQL);
     update apidb_r.TuningFamily$dblink
       set subversion_url = '$url'
       where family_name = '$family'
SQL
  printf "updated subversion URL to \"$url\" (from config of \"$svn\") for %d "
    . (($familyCount == 1) ? "family" : "families") . " named \"$family\".\n", $familyCount;
}

sub svnUrl {
  my ($svn) = @_;
  return "https://www.cbil.upenn.edu/svn/apidb/ApiCommonData/$svn/Load/lib/xml"
}

sub archive {
  my ($dbh, $dblink, $instanceNickname, $archiveFlag) = @_;

  my $rowCount = $dbh->do(<<SQL) or die $dbh->errstr;
     update apidb_r.TuningInstance$dblink
       set archived = $archiveFlag
  where instance_nickname = '$instanceNickname'
SQL

  printf "set \"archived\" to " . $archiveFlag . " for " . $rowCount . ($rowCount == 1 ? " instance" : " instances") . ", nicknamed \"$instanceNickname\"\n";
}

sub  {
   my ($dbh, $dblink, $instanceNickname, $archiveFlag) = @_;

   # set svn, based on family
   my $url = svnUrl($svn);
   my $familyCount = $dbh->do(<<SQL);
SQL
  printf "set archive to \"$archiveFlag\" of \"$svn\") for %d "
    . (($familyCount == 1) ? "family" : "families") . " named \"$family\".\n", $familyCount;
}

