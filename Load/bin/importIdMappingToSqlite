#!/bin/bash

set -euo pipefail

# Script to import idmapping_selected.tab.gz into an SQLite3 database
# Usage: importIdMappingToSqlite <data_directory>
# Input: <data_directory>/idmapping_selected.tab.gz
# Output: <data_directory>/idmapping.db

if [ $# -ne 1 ]; then
    echo "Usage: $0 <data_directory>"
    echo "Example: $0 /path/to/data"
    exit 1
fi

DATA_DIR="$1"
INPUT_FILE="${DATA_DIR}/idmapping_selected.tab.gz"
OUTPUT_DB="${DATA_DIR}/idmapping.db"

# Check if data directory exists
if [ ! -d "$DATA_DIR" ]; then
    echo "Error: Data directory not found: $DATA_DIR"
    exit 1
fi

# Check if input file exists
if [ ! -f "$INPUT_FILE" ]; then
    echo "Error: Input file not found: $INPUT_FILE"
    exit 1
fi

# Remove existing database if present
if [ -f "$OUTPUT_DB" ]; then
    echo "Removing existing database: $OUTPUT_DB"
    rm -f "$OUTPUT_DB"
fi

echo "Creating SQLite database: $OUTPUT_DB"
echo "Processing input file: $INPUT_FILE"

# Create the database and table schema
sqlite3 "$OUTPUT_DB" <<'EOF'
CREATE TABLE idmapping (
    uniprot_ac TEXT,
    gene_id TEXT,
    refseq TEXT,
    gi TEXT,
    ncbi_taxon INTEGER,
    embl TEXT,
    embl_cds TEXT
);

CREATE INDEX idx_ncbi_taxon ON idmapping(ncbi_taxon);
EOF

echo "Table created. Importing data..."

# Create a temporary file for import (SQLite .import doesn't work well with stdin)
TEMP_FILE=$(mktemp)
trap "rm -f $TEMP_FILE" EXIT

# Extract selected columns (1,3,4,5,13,17,18)
zcat "$INPUT_FILE" | cut -f1,3,4,5,13,17,18 > "$TEMP_FILE"

# Import the data
sqlite3 "$OUTPUT_DB" <<EOF
.mode tabs
.import $TEMP_FILE idmapping
EOF

# Get record count
RECORD_COUNT=$(sqlite3 "$OUTPUT_DB" "SELECT COUNT(*) FROM idmapping;")

echo "Import complete!"
echo "Total records imported: $RECORD_COUNT"
echo "Database location: $OUTPUT_DB"

# Display some sample queries
echo ""
echo "Sample queries you can run:"
echo "  sqlite3 $OUTPUT_DB \"SELECT * FROM idmapping LIMIT 10;\""
echo "  sqlite3 $OUTPUT_DB \"SELECT COUNT(*) FROM idmapping WHERE ncbi_taxon = 9606;\""
echo "  sqlite3 $OUTPUT_DB \"SELECT * FROM idmapping WHERE uniprot_ac = 'P04637';\""
