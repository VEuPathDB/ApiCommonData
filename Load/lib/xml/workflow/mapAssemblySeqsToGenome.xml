<workflowGraph name="mapAssemblySeqsToGenome">

    <param name="parentDataDir"/>
    <param name="genomeExtDbRlsSpec"/>
    <param name="parentNcbiTaxonId"/>
    <param name="ncbiTaxonId"/>
    <param name="maxIntronSize"/>
    <param name="assemblySeqsDataDir"/>
    <param name="dataDir"/>
    <param name="genomicSeqsDir"/>
    <param name="maxIntronSize"/>

    <step name="makeDataDir" stepClass="ApiCommonData::Load::WorkflowSteps::MakeDataDir">
      <paramValue name="dataDir">$$dataDir$$</paramValue>
    </step>

    <step name="extractGenomicSeqsIntoSeparateFastaFiles"
          stepClass="ApiCommonData::Load::WorkflowSteps::ExtractNaSeqs">
      <paramValue name="extDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="table">ExternalNASequence</paramValue>
      <paramValue name="outputFile"></paramValue>
      <paramValue name="alternateDefline"></paramValue>
      <paramValue name="separateFastaFiles">true</paramValue>
      <paramValue name="outputDirForSeparateFiles">$$genomicSeqsDir$$</paramValue>
      <depends name="makeDataDir"/>
    </step>

    <step name="makeTaskInputDir" stepClass="ApiCommonData::Load::WorkflowSteps::MakeGfClientTaskInputDir">
      <paramValue name="taskInputDir">$$dataDir$$/input</paramValue>
      <paramValue name="maxIntronSize">$$maxIntronSize$$</paramValue>
      <paramValue name="queryFile">$$assemblySeqsDataDir$$/master/mainresult/blocked.seq</paramValue>
      <paramValue name="targetDir">$$genomicSeqsDir$$</paramValue>
      <depends name="makeDataDir"/>
      <depends name="extractGenomicSeqsIntoSeparateFastaFiles"/>
    </step>

    <step name="mirrorToCluster" stepClass="ApiCommonData::Load::WorkflowSteps::MirrorToComputeCluster" stepLoadTypes="cluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$</paramValue>
      <depends name="makeTaskInputDir"/>
      <depends name="extractGenomicSeqsIntoSeparateFastaFiles"/>
    </step>

    <step name="runNibOnCluster" stepClass="ApiCommonData::Load::WorkflowSteps::RunNibOnCluster" stepLoadTypes="cluster">
      <paramValue name="inputFile">$$dataDir$$/input/targetList</paramValue>
      <paramValue name="outputDir">$$genomicSeqsDir$$</paramValue>
      <depends name="mirrorToCluster"/>
    </step>

    <step name="runClusterTask" stepClass="ApiCommonData::Load::WorkflowSteps::RunAndMonitorClusterTask" stepLoadTypes="cluster">
      <paramValue name="taskInputDir">$$dataDir$$/input</paramValue>
      <paramValue name="numNodes">1</paramValue>
      <paramValue name="processorsPerNode">1</paramValue>
      <depends name="runNibOnCluster"/>
    </step>

    <step name="mirrorFromCluster" stepClass="ApiCommonData::Load::WorkflowSteps::MirrorFromComputeCluster" stepLoadTypes="cluster">
      <paramValue name="fileOrDirToMirror">$$dataDir$$/master</paramValue>
      <paramValue name="outputDir">$$dataDir$$/master/mainresult</paramValue>
      <paramValue name="outputFiles">out.psl</paramValue>
      <depends name="runClusterTask"/>
    </step>

    <step name="InsertGusTableWithXml" stepClass="ApiCommonData::Load::WorkflowSteps::InsertGusTableWithXml" stepLoadTypes="cluster">
      <paramValue name="xmlFileRelativeToGusHomeDir">/config/blatalignmentquality.xml</paramValue>
      <paramValue name="gusTable">BlatAlignmentQuality</paramValue>
    </step>

    <step name="insertBlatAlignment" stepClass="ApiCommonData::Load::WorkflowSteps::InsertBlatAlignment" stepLoadTypes="cluster">

      <paramValue name="targetNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="queryNcbiTaxId">$$parentNcbiTaxonId$$</paramValue>
      <paramValue name="targetExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="queryExtDbRlsSpec"></paramValue>
      <paramValue name="targetTable">ExternalNASequence</paramValue>
      <paramValue name="queryTable">AssemblySequence</paramValue>
      <paramValue name="regex">>(\\d+)</paramValue>
      <paramValue name="action">load</paramValue>
      <paramValue name="percentTop"></paramValue>
      <paramValue name="blatFile">$$dataDir$$/master/mainresult/out.psl</paramValue>
      <paramValue name="queryFile">$$assemblySeqsDataDir$$/master/mainresult/blocked.seq</paramValue>
      <depends name="mirrorFromCluster"/>
      <depends name="InsertGusTableWithXml"/>
    </step>

    <step name="setBestBlatAlignment" stepClass="ApiCommonData::Load::WorkflowSteps::InsertBlatAlignment" stepLoadTypes="cluster">

      <paramValue name="targetNcbiTaxId">$$ncbiTaxonId$$</paramValue>
      <paramValue name="queryNcbiTaxId">$$parentNcbiTaxonId$$</paramValue>
      <paramValue name="targetExtDbRlsSpec">$$genomeExtDbRlsSpec$$</paramValue>
      <paramValue name="queryExtDbRlsSpec"></paramValue>
      <paramValue name="targetTable">ExternalNASequence</paramValue>
      <paramValue name="queryTable">AssemblySequence</paramValue>
      <paramValue name="regex">>(\\d+)</paramValue>
      <paramValue name="action">setbest</paramValue>
      <paramValue name="percentTop">100</paramValue>
      <paramValue name="blatFile">$$dataDir$$/master/mainresult/out.psl</paramValue>
      <paramValue name="queryFile">$$assemblySeqsDataDir$$/master/mainresult/blocked.seq</paramValue>
      <depends name="insertBlatAlignment"/>
    </step>

</workflowGraph>
