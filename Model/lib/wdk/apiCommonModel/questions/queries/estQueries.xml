<wdkModel>

  <!-- notes

  -->

  <querySet name="EstIds" queryType="id">

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Source id  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="EstBySourceId" doNotTest="true" excludeProjects="EuPathDB"
         isCacheable="true">
        <paramRef ref="estParams.est_id"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql>
          <![CDATA[
            SELECT DISTINCT ea.source_id, '@PROJECT_ID@' as project_id
            FROM apidb.EstAttributes ea, @WDK_ENGINE_SCHEMA@dataset_values@USER_DBLINK@ ds
            WHERE ds.dataset_id = $$est_id$$
              AND ea.project_id = '@PROJECT_ID@'
              AND ea.source_id LIKE REGEXP_REPLACE(REPLACE(ds.dataset_value,
                                                       '*', '%'),
                                               '[[:space:]]', '')
              AND LOWER(ea.project_id) = LOWER('@PROJECT_ID@')
          ]]>
       </sql>
    </sqlQuery>

    <processQuery name="EstBySourceId" includeProjects="EuPathDB"
          isCacheable='true' 
          processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin"> 
        <paramRef ref="estParams.est_id"/>
        <paramRef ref="sharedParams.signature" quote="false"/>
        <wsColumn name="source_id" width="32" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>   


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Location  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

 <!-- TODO:  Cannot test queries that use dependent params -->
    <sqlQuery name="EstsByLocation" excludeProjects="EuPathDB"
          isCacheable="true" doNotTest="true">

        <testParamValues includeProjects="CryptoDB">
          <paramValue name="sequenceId">AAEE01000001</paramValue>
          <paramValue name="libraryId">WatanabeCpHNJ-1 (oocyst)</paramValue> 
        </testParamValues>

        <testParamValues includeProjects="PlasmoDB">
          <paramValue name="sequenceId">Pf3D7_01</paramValue> 
        </testParamValues>

        <testParamValues includeProjects="TriTrypDB">
          <paramValue name="sequenceId">Tb927_02_v4</paramValue> 
        </testParamValues>


        <testParamValues includeProjects="ToxoDB">
          <paramValue name="sequenceId">Neo_chrIII</paramValue>
          <paramValue name="libraryId">Nc-1 Tachyzoite cDNA Library 2</paramValue> 
        </testParamValues>
<!--
        <paramRef ref="organismParams.organismWithEstsInChromosomes" 
                  includeProjects="PlasmoDB"/>
        <paramRef ref="organismParams.sequence_organism_text" includeProjects="ToxoDB"/>
-->
        <paramRef ref="organismParams.organism"  queryRef="organismVQ.withChromosomesESTsAssems" multiPick="false" includeProjects="CryptoDB"/>
        <paramRef ref="organismParams.organism"  queryRef="organismVQ.withChromosomesESTsAssems" multiPick="false" includeProjects="ToxoDB" default="Toxoplasma gondii ME49"/>
        <paramRef ref="organismParams.organism"  queryRef="organismVQ.withChromosomesESTsAssems" multiPick="false" includeProjects="TriTrypDB" default="Leishmania major"/>
        <paramRef ref="organismParams.organism"  queryRef="organismVQ.withChromosomesESTsAssems" multiPick="false" default="Plasmodium vivax" includeProjects="PlasmoDB"/>
        <paramRef ref="sharedParams.chromosomeOptional"  includeProjects="PlasmoDB,CryptoDB,ToxoDB,TriTrypDB"/>
  
        <paramRef ref="sharedParams.sequenceId"/>
        <paramRef ref="sharedParams.start_point"/>
        <paramRef ref="sharedParams.end_point"/>
        <paramRef ref="sharedParams.libraryId"/>
        <paramRef ref="sharedParams.best_alignment_only" 
                  groupRef="paramGroups.advancedParams"/>
        <paramRef ref="sharedParams.high_confidence_only" 
                  groupRef="paramGroups.advancedParams"/>
        <paramRef ref="sharedParams.min_percent_identity" 
                  groupRef="paramGroups.advancedParams"/>
        <paramRef ref="sharedParams.min_percent_est_aligned" 
                  groupRef="paramGroups.advancedParams"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="est_location"/>
        <sqlParamValue name="chroOpt" includeProjects="CryptoDB">
            <![CDATA[
              (s.source_id IN ($$chromosomeOptional$$)
               OR lower(s.source_id) = lower($$sequenceId$$))
            ]]>
        </sqlParamValue>

<!-- not needed when we unify params 
        <sqlParamValue name="orgParam" includeProjects="ToxoDB">
            <![CDATA[
              $$sequence_organism_text$$
            ]]>
        </sqlParamValue>
        <sqlParamValue name="orgParam" includeProjects="PlasmoDB">
            <![CDATA[
              $$organismWithEstsInChromosomes$$
            ]]>
        </sqlParamValue>
        <sqlParamValue name="chrParam" includeProjects="ToxoDB">
            <![CDATA[
              $$chromosomeOptional$$
            ]]>
        </sqlParamValue>
        <sqlParamValue name="chrParam" includeProjects="PlasmoDB">
            <![CDATA[
              $$chromosomeOptionalForEsts$$
            ]]>
        </sqlParamValue>
-->
        <sqlParamValue name="chroOpt" includeProjects="GiardiaDB,TrichDB">
           <![CDATA[ lower(s.source_id) = lower($$sequenceId$$)]]>
        </sqlParamValue>
        <sql excludeProjects="PlasmoDB,ToxoDB,CryptoDB,TriTrypDB">
            <![CDATA[
            select * from (
            SELECT eags.accession as source_id, '@PROJECT_ID@' as project_id,
                   apidb.tab_to_string(
                     CAST(
                       COLLECT(s.source_id || ':'
                       || trim(to_char(b.target_start,'999,999,999'))
                       || '-' || trim(to_char(b.target_end,'999,999,999'))
                       || '(' || decode(b.is_reversed,0,'+',1,'-',null)
                       || ')') AS apidb.varchartab), ', ') AS est_location
            FROM  apidb.blatalignmentlocation b, apidb.ESTALIGNMENTGENESUMMARY eags, apidb.sequenceattributes s
            WHERE &&chroOpt&&
            AND   s.na_sequence_id = b.target_na_sequence_id
            AND   b.target_start >=  REGEXP_REPLACE('$$start_point$$', ',| ','')
            AND   (b.target_end <= REGEXP_REPLACE('$$end_point$$', ',| ','') OR REGEXP_REPLACE('$$end_point$$', ',| ','') = 0)
            AND   b.is_consistent in ($$high_confidence_only$$)
            AND   b.is_best_alignment in ($$best_alignment_only$$)
            AND   b.percent_identity >= $$min_percent_identity$$
            AND   b.blat_alignment_id = eags.BLAT_ALIGNMENT_ID
            AND   eags.percent_est_bases_aligned >= $$min_percent_est_aligned$$
            AND   eags.library_id in ($$libraryId$$)
            GROUP BY eags.accession)
           ]]>
        </sql>

        <sql includeProjects="PlasmoDB,ToxoDB,CryptoDB">
            <![CDATA[
            select * from (
            SELECT eags.accession as source_id, '@PROJECT_ID@' as project_id,
                   apidb.tab_to_string(
                     CAST(
                       COLLECT(sa.source_id || ':'
                       || trim(to_char(b.target_start,'999,999,999'))
                       || '-' || trim(to_char(b.target_end,'999,999,999'))
                       || '(' || decode(b.is_reversed,0,'+',1,'-',null)
                       || ')') AS apidb.varchartab), ', ') AS est_location
            FROM  apidb.blatalignmentlocation b, apidb.ESTALIGNMENTGENESUMMARY eags, apidb.sequenceAttributes sa
            WHERE ((sa.chromosome=$$chromosomeOptional$$ and sa.organism = $$organism$$)
               OR lower(sa.source_id) = lower($$sequenceId$$))
            AND   sa.na_sequence_id = b.target_na_sequence_id
            AND   b.target_start >=  REGEXP_REPLACE('$$start_point$$', ',| ','')
            AND   (b.target_end <= REGEXP_REPLACE('$$end_point$$', ',| ','') OR REGEXP_REPLACE('$$end_point$$', ',| ','') = 0)
            AND   b.is_consistent in ($$high_confidence_only$$)
            AND   b.is_best_alignment in ($$best_alignment_only$$)
            AND   b.percent_identity >= $$min_percent_identity$$
            AND   b.blat_alignment_id = eags.BLAT_ALIGNMENT_ID
            AND   eags.percent_est_bases_aligned >= $$min_percent_est_aligned$$
            AND   eags.library_id in ($$libraryId$$)
            GROUP BY eags.accession)
           ]]>
        </sql>

        <sql includeProjects="TriTrypDB">
            <![CDATA[
            select * from (
            SELECT eags.accession as source_id, '@PROJECT_ID@' as project_id,
                   apidb.tab_to_string(
                     CAST(
                       COLLECT(sa.source_id || ':'
                       || trim(to_char(b.target_start,'999,999,999'))
                       || '-' || trim(to_char(b.target_end,'999,999,999'))
                       || '(' || decode(b.is_reversed,0,'+',1,'-',null)
                       || ')') AS apidb.varchartab), ', ') AS est_location
            FROM  apidb.blatalignmentlocation b, apidb.ESTALIGNMENTGENESUMMARY eags, apidb.sequenceAttributes sa
            WHERE ((sa.chromosome_order_num=$$chromosomeOptional$$ and sa.organism = $$organism$$)
               OR lower(sa.source_id) = lower($$sequenceId$$))
            AND   sa.na_sequence_id = b.target_na_sequence_id
            AND   b.target_start >=  REGEXP_REPLACE('$$start_point$$', ',| ','')
            AND   (b.target_end <= REGEXP_REPLACE('$$end_point$$', ',| ','') OR REGEXP_REPLACE('$$end_point$$', ',| ','') = 0)
            AND   b.is_consistent in ($$high_confidence_only$$)
            AND   b.is_best_alignment in ($$best_alignment_only$$)
            AND   b.percent_identity >= $$min_percent_identity$$
            AND   b.blat_alignment_id = eags.BLAT_ALIGNMENT_ID
            AND   eags.percent_est_bases_aligned >= $$min_percent_est_aligned$$
            AND   eags.library_id in ($$libraryId$$)
            GROUP BY eags.accession)
           ]]>
        </sql>
    </sqlQuery>

    <processQuery name="EstsByLocation" includeProjects="EuPathDB" 
          isCacheable="true" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
        <!--<paramRef ref="organismParams.organism" queryRef="organismVQ.withChromosomes"/>-->
        <paramRef ref="organismParams.organism" queryRef="organismVQ.withGenesGFF"/>
        <paramRef ref="sharedParams.chromosomeOptional"  quote="false"/>
        <paramRef ref="sharedParams.sequenceId"  quote="false"/>
        <paramRef ref="sharedParams.start_point"/>
        <paramRef ref="sharedParams.end_point"/>
        <paramRef ref="sharedParams.libraryId"/>
        <paramRef ref="sharedParams.best_alignment_only" groupRef="paramGroups.advancedParams"/>
        <paramRef ref="sharedParams.high_confidence_only" groupRef="paramGroups.advancedParams"/>
        <paramRef ref="sharedParams.min_percent_identity" groupRef="paramGroups.advancedParams"/>
        <paramRef ref="sharedParams.min_percent_est_aligned" groupRef="paramGroups.advancedParams"/>
        <wsColumn name="source_id" width="60" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
        <wsColumn name="est_location" width="100" wsName="est_location"/>
    </processQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Library  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="EstsByLibrary" excludeProjects="EuPathDB" 
             isCacheable='true'>
        <paramRef ref="sharedParams.libraryId"/>
        <column name="source_id" />
        <column name="project_id"/>
        <sql>
            SELECT ea.source_id, ea.project_id
            FROM apidb.EstAttributes ea
            WHERE ea.library_id in ($$libraryId$$)
              AND ea.project_id = '@PROJECT_ID@'
       </sql>
    </sqlQuery>

    <processQuery name="EstsByLibrary" includeProjects="EuPathDB" 
             displayName="Library Name" isCacheable='true' 
             processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" >
        <paramRef ref="sharedParams.libraryId"/>
        <wsColumn name="source_id" width="60" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Gene Overlap  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="EstsWithGeneOverlap" excludeProjects="EuPathDB"
            isCacheable='true'>
       <paramRef ref="sharedParams.libraryIdGenes" />
       <paramRef ref="sharedParams.bp_overlap_gte"/>
       <paramRef ref="estParams.overlapOrNot"/>
       <paramRef ref="sharedParams.best_alignment_only" 
             groupRef="paramGroups.advancedParams"/>
       <paramRef ref="sharedParams.high_confidence_only"
             groupRef="paramGroups.advancedParams"/>
       <paramRef ref="sharedParams.min_percent_identity"
             groupRef="paramGroups.advancedParams"/>
       <paramRef ref="sharedParams.min_percent_est_aligned"
             groupRef="paramGroups.advancedParams"/>
       <column name="source_id" />
       <column name="project_id"/>
       <column name="est_locations"/>
       <column name="genes"/>
       <sql>
            <![CDATA[
              select * from (
              SELECT accession as source_id, '@PROJECT_ID@' as project_id,
               CASE WHEN count(*) > 20 THEN count(*)||' locations' ELSE apidb.tab_to_string(
                    CAST(
                      COLLECT(target_sequence_source_id || ':'
                      || trim(to_char(target_start,'999,999,999'))
                      || '-' || trim(to_char(target_end,'999,999,999'))
                      || '(' || decode(is_reversed,0,'+',1,'-',null) || ')')
                    AS apidb.varchartab), ', ') END AS est_locations,
                  CASE WHEN count(distinct gene) > 20 THEN count(distinct gene)||' genes'
                       ELSE apidb.tab_to_string(CAST(COLLECT(gene) AS apidb.varchartab), ', ') END as genes
	    FROM (
                SELECT accession,gene ,target_start,target_end, is_reversed, target_sequence_source_id
                FROM apidb.EstAlignmentGeneSummary
                WHERE ('overlap' != $$overlapOrNot$$ OR est_gene_overlap_length >= $$bp_overlap_gte$$)
                  AND ('not overlap' != $$overlapOrNot$$ OR (est_gene_overlap_length < $$bp_overlap_gte$$ OR est_gene_overlap_length is null))
                  AND is_consistent in ($$high_confidence_only$$)
                  AND is_best_alignment in ($$best_alignment_only$$)
                  AND percent_identity >= $$min_percent_identity$$
                  AND percent_est_bases_aligned >= $$min_percent_est_aligned$$
                  AND library_id in ($$libraryIdGenes$$)
            )
            GROUP BY accession
            )
           ]]>
       </sql>

    </sqlQuery>


    <processQuery name="EstsWithGeneOverlap" includeProjects="EuPathDB"
       isCacheable='true' processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
       <paramRef ref="sharedParams.libraryIdGenes"/>
       <paramRef ref="sharedParams.bp_overlap_gte"/>
       <paramRef ref="estParams.overlapOrNot"/>
       <wsColumn name="source_id" width="60" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- BLAST  -->
    <!-- in blast.js: assemblies also use this question page -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <processQuery name="EstsBySimilarity" 
             displayName="BLAST"
             processName="org.apidb.apicomplexa.wsfplugin.wublast.WuBlastPlugin">

        <testParamValues includeProjects="GiardiaDB">
            <paramValue name="BlastQuerySequence">AAAATTTACCTCCTTACACCACAGTTAGTCCAGATCATCGACACTGGGACCCGCAGGGGCACCGCCTGGGGCCGCGCCACCGGGCATCCCGCCAGGGAATCCGCCGGGGAACCCACCAGG</paramValue>
            <paramValue name="BlastDatabaseType">EST</paramValue>
        </testParamValues>

        <testParamValues includeProjects="CryptoDB">
            <paramValue name="BlastQuerySequence">TAGGGGTATAGCTGAGATAGTTTTACTTGCTGCAGATGC</paramValue>
            <paramValue name="BlastDatabaseType">EST</paramValue>
        </testParamValues>

        <testParamValues includeProjects="ToxoDB">
            <paramValue name="BlastQuerySequence">CCACTGAGGACGGAGATGAGTCTCTCTCCTACATGAGAAGGGGAGTTTACGTGGGTCGGGGGAAAAACTACTGGCCTGTCG</paramValue>
            <paramValue name="BlastDatabaseType">EST</paramValue>
        </testParamValues>

        <testParamValues includeProjects="PlasmoDB">
            <paramValue name="BlastQuerySequence">ATGTTCGTAAAAAATTTTATACATAAATTAAAAGAATTAAAACAAAAATCTTTAGATAAGTTCGCTAATTTATTGTATGATTATGGAGGTTATGTATATGATAGACCTTGTACCTTTATTATATGTAGTTTAATATGTTGTTTACTTTTAACTTGTGGTTTTTATTTTAAAGAACATGAGAAAGATATTTATAAATTATATTCAATATCCAATTCGTATGCCTACGAAACGAATGAAACC</paramValue>
            <paramValue name="BlastDatabaseType">EST</paramValue>
        </testParamValues>

        <testParamValues includeProjects="TrichDB">
            <paramValue name="BlastQuerySequence">CTCATCGACTGTGACTGGCTCTGGGAATGCACGGTGAGCTGTATCGTACTTAAGGAGGTAAACGTTTGTCTTGATGTCACCAAGATCGTGGATAGCGACAACTTGGATATCCTTTGGATA</paramValue>
            <paramValue name="BlastDatabaseType">EST</paramValue>
        </testParamValues>

        <testParamValues includeProjects="TriTrypDB">
            <paramValue name="BlastQuerySequence">AAAAGAGGATACAACCGTTGGAAGGGGTGAGGAAGGAACCCTGCAAAGAAATCTTCTCCCTTTTCTTTTTTTACTTTTTT</paramValue>
            <paramValue name="BlastDatabaseType">EST</paramValue>
        </testParamValues>

       <paramRef ref="sharedParams.BlastDatabaseType" quote="false" />
       <paramRef ref="sharedParams.BlastAlgorithm" quote="false" />
       <paramRef ref="estSimilarityParams.BlastDatabaseOrganism" quote="false" />
       <paramRef ref="sharedParams.BlastQuerySequence" quote="false" />
       <paramRef ref="sharedParams.-e" quote="false" />
       <paramRef ref="sharedParams.-v" quote="false" />
       <paramRef ref="sharedParams.-b" quote="false" />
       <paramRef ref="sharedParams.-filter" quote="false" />

       <wsColumn name="source_id" width="32" wsName="Identifier"/>
       <wsColumn name="project_id" width="32" wsName="ProjectId"/>
       <wsColumn name="TabularRow" width="3000"/>
       <wsColumn name="Alignment"  columnType="clob"/>
       <wsColumn name="Header" width="3000"/>
       <wsColumn name="Footer" width="3000"/>
 <wsColumn name="Counter" width="30" columnType="number"/>
    </processQuery>

<!--
    <processQuery name="EstsBySimilarity" includeProjects="EuPathDB"
         displayName="BLAST ESTs" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
       <paramRef ref="sharedParams.BlastDatabaseType"/>
       <paramRef ref="estSimilarityParams.BlastDatabaseOrganism"/>
       <paramRef ref="sharedParams.BlastAlgorithm"/>
       <paramRef ref="sharedParams.BlastQuerySequence"/>
       <paramRef ref="sharedParams.-e"/>
       <paramRef ref="sharedParams.-v"/>
       <paramRef ref="sharedParams.-b"/>
       <paramRef ref="sharedParams.-filter"/>
       <wsColumn name="source_id" width="60" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
       <wsColumn name="TabularRow" width="3000"/>
       <wsColumn name="Alignment" width="4000"/>
       <wsColumn name="Header" width="3000"/>
       <wsColumn name="Footer" width="3000"/>
    </processQuery>
-->

  </querySet>
</wdkModel>
