<wdkModel>

  <querySet name="SageTagIds" queryType="id">


    <sqlQuery name="ByRStat" doNotTest="true" includeProjects="GiardiaDB,ToxoDB,PlasmoDB"
              isCacheable="true">

       <paramRef ref="geneParams.sage_tag_library_name"/>
       <paramRef ref="geneParams.sage_tag_min_r"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="R"/>
       <sql>
         <![CDATA[
       select source_id,
              '@PROJECT_ID@' as project_id, 
              to_char(sum(xij * log(10, (xij/(Ni * fj)))), '99999D0') as R
       from (
         select a.source_id, aa.library_name, library_count.n as ni, f.frequency as fj, sum(aa.raw_count) as xij
         from apidb.SAGETAGANALYSISATTRIBUTES aa, 
              apidb.SAGETAGATTRIBUTES a,
              (select a.source_id, sum(aa.raw_count) / max(n.n) as frequency
               from apidb.SAGETAGANALYSISATTRIBUTES aa, 
               apidb.SAGETAGATTRIBUTES a,
               (select sum(max(total_raw_count)) as n
                from apidb.SAGETAGANALYSISATTRIBUTES
                where library_name in ($$sage_tag_library_name$$)
                group by library_name) n
               where aa.library_name in ($$sage_tag_library_name$$)
                and aa.composite_element_id = a.composite_element_id
               group by a.source_id) f,
              (select library_name, max(total_raw_count) as n
               from apidb.SAGETAGANALYSISATTRIBUTES
               where library_name in ($$sage_tag_library_name$$)
               group by library_name) library_count
         where aa.composite_element_id = a.composite_element_id
          and a.source_id = f.source_id
          and aa.library_name = library_count.library_name
         group by a.source_id, aa.library_name, library_count.n, f.frequency
         )
       group by source_id
       having sum(xij * log(10, (xij/(Ni * fj)))) >  $$sage_tag_min_r$$
         ]]>
       </sql>
    </sqlQuery>

<processQuery name="ByRStat" includeProjects="EuPathDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">

      <paramRef ref="geneParams.sage_tag_library_name" quote="false"/>
       <paramRef ref="geneParams.sage_tag_min_r"/>

       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
       <wsColumn name="R"/>

 </processQuery> 



    <sqlQuery name="ByLocation" includeProjects="GiardiaDB,PlasmoDB,ToxoDB"
              isCacheable="true">

        <testParamValues includeProjects="ToxoDB">
          <paramValue name="chromosomeOptional2">V</paramValue>
        </testParamValues>

        <paramRef includeProjects="GiardiaDB" ref="sharedParams.sequenceId"/>
 <!--       <paramRef includeProjects="PlasmoDB" ref="sharedParams.chromosome"/>
       <paramRef ref="sharedParams.chromosomeOptional" includeProjects="ToxoDB"/>  -->
      <paramRef ref="sharedParams.chromosomeOptional2" includeProjects="PlasmoDB,ToxoDB"/>
        <paramRef ref="sharedParams.start_point"/>
        <paramRef ref="sharedParams.end_point"/>
        <paramRef ref="sageTagParams.is_within_gene_not"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="dynamic_location"/>
        <sqlParamValue name="source" includeProjects="GiardiaDB">
          <![CDATA[ lower(a.sequence_source_id) = lower($$sequenceId$$) ]]>
        </sqlParamValue>
        <sqlParamValue name="source" includeProjects="PlasmoDB">
          <![CDATA[ a.sequence_source_id in ($$chromosomeOptional2$$) ]]>
        </sqlParamValue>
       <sql includeProjects="GiardiaDB,PlasmoDB">
         <![CDATA[
            select distinct sta.source_id as source_id, '@PROJECT_ID@' as project_id,
              a.sequence_source_id || ': ' || trim(to_char(a.start_min,'999,999,999')) || ' - ' || trim(to_char(a.end_max,'999,999,999')) || decode(a.is_reversed, 1, ' (-)', ' (+)') as dynamic_location
            from apidb.sagetagattributes sta, apidb.featurelocation a left join apidb.SAGETAGGENE sg
                  on a.na_feature_id = sg.tag_feature_id and sg.distance = 0 and sg.antisense = 0
            where  &&source&&
              AND  a.feature_type = 'SAGETagFeature'
              AND  a.end_max >=  REGEXP_REPLACE('$$start_point$$', ',| ','')
              AND  (a.start_min <=  REGEXP_REPLACE('$$end_point$$', ',| ','') OR  REGEXP_REPLACE('$$end_point$$', ',| ','') = 0)
              AND  sta.na_feature_id = a.na_feature_id
              AND (sg.gene_source_id is $$is_within_gene_not$$ null OR sg.gene_source_id is not null)
         ]]>
       </sql>
       <sql includeProjects="ToxoDB">
         <![CDATA[
            select distinct sta.source_id as source_id, '@PROJECT_ID@' as project_id,
              a.sequence_source_id || ': ' || trim(to_char(a.start_min,'999,999,999')) || ' - ' || trim(to_char(a.end_max,'999,999,999')) || decode(a.is_reversed, 1, ' (-)', ' (+)') as dynamic_location
            from apidb.sequenceattributes satr, apidb.sagetagattributes sta, apidb.featurelocation a left join apidb.SAGETAGGENE sg
                  on a.na_feature_id = sg.tag_feature_id and sg.distance = 0 and sg.antisense = 0
            where  satr.chromosome = $$chromosomeOptional2$$
              AND  a.na_sequence_id = satr.na_sequence_id
              AND  a.feature_type = 'SAGETagFeature'
              AND  a.end_max >=  REGEXP_REPLACE('$$start_point$$', ',| ','')
              AND  (a.start_min <=  REGEXP_REPLACE('$$end_point$$', ',| ','') OR  REGEXP_REPLACE('$$end_point$$', ',| ','') = 0)
              AND  sta.na_feature_id = a.na_feature_id
              AND (sg.gene_source_id is $$is_within_gene_not$$ null OR sg.gene_source_id is not null)
         ]]>
       </sql>
    </sqlQuery>

<processQuery name="ByLocation" includeProjects="EuPathDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">

        <paramRef ref="sharedParams.sequenceId" default="(Example: CH991779)"  quote="false"/>
        <paramRef ref="sharedParams.chromosomeOptional2"  quote="false"/>
        <paramRef ref="sharedParams.start_point"/>
        <paramRef ref="sharedParams.end_point"/>
        <paramRef ref="sageTagParams.is_within_gene_not"  quote="false"/>

       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
       <wsColumn name="dynamic_location" width="100" wsName="dynamic_location"/>
  </processQuery> 


    <sqlQuery name="BySequence" includeProjects="ToxoDB,PlasmoDB,GiardiaDB"
              isCacheable="true">
        <paramRef ref="sageTagParams.sequence"/>
        <paramRef ref="sageTagParams.is_within_gene"/>
        <column name="source_id"/>
        <column name="project_id"/>
       <sql>
         <![CDATA[
         select distinct a.source_id, a.project_id 
         from apidb.SageTagAttributes a, apidb.SageTagGene sg
         where (lower(a.sequence) = lower($$sequence$$) 
                 OR lower('catg' || a.sequence) = lower($$sequence$$) )
         and a.na_feature_id = sg.tag_feature_id $$is_within_gene$$ 
         and sg.distance $$is_within_gene$$ = 0
         ]]>
       </sql>
    </sqlQuery>

<processQuery name="BySequence" includeProjects="EuPathDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
       <paramRef ref="sageTagParams.sequence" quote="false"/>
       <paramRef ref="sageTagParams.is_within_gene"/>
       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
  </processQuery> 

 
    <sqlQuery name="ByGeneSourceId" includeProjects="ToxoDB,PlasmoDB,GiardiaDB"
              isCacheable="true">
        <paramRef ref="sageTagParams.single_gene_id"/>
        <paramRef ref="geneParams.st_max_five_prime_distance"/>
        <paramRef ref="geneParams.st_max_three_prime_distance"/>
        <column name="source_id"/>
        <column name="project_id"/>
       <sql>
         <![CDATA[
         select distinct a.source_id, a.project_id
         from apidb.SageTagAttributes a, apidb.SageTagGene sg
         where a.na_feature_id = sg.tag_feature_id
         and sg.antisense = 0
         and sg.gene_source_id LIKE REGEXP_REPLACE(REPLACE($$single_gene_id$$,'*', '%'),'[[:space:]]', '')
         and ((sg.direction = '5' and sg.distance <= $$st_max_five_prime_distance$$)
             OR (sg.direction = '3' and sg.distance <= $$st_max_three_prime_distance$$))
         ]]>
       </sql>
</sqlQuery>
 
<processQuery name="ByGeneSourceId" includeProjects="EuPathDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">

       <paramRef ref="sageTagParams.single_gene_id" quote="false"/>
       <paramRef ref="geneParams.st_max_five_prime_distance"/>
       <paramRef ref="geneParams.st_max_three_prime_distance"/>
      
       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
   </processQuery> 

  
 <sqlQuery name="ByRadSourceId" doNotTest="true" includeProjects="GiardiaDB,PlasmoDB,ToxoDB"
              isCacheable="true">
        <paramRef ref="sageTagParams.rad_source_id"/>
        <column name="source_id"/>
        <column name="project_id"/>
       <sql>
         <![CDATA[
         select distinct a.source_id, a.project_id
         from apidb.SageTagAttributes a, @WDK_ENGINE_SCHEMA@dataset_values@USER_DBLINK@ ds
         where ds.dataset_id =  $$rad_source_id$$
           and (a.rad_source_id LIKE REGEXP_REPLACE(REPLACE(ds.dataset_value,'*', '%'),'[[:space:]]', '') 
                 or a.source_id LIKE REGEXP_REPLACE(REPLACE(ds.dataset_value,'*', '%'),'[[:space:]]', ''))
         ]]>
       </sql>
</sqlQuery>

 <processQuery name="ByRadSourceId" includeProjects="EuPathDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
       <paramRef ref="sageTagParams.rad_source_id"/>
       <paramRef ref="sharedParams.signature" quote="false"/>
       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
   </processQuery> 


 <sqlQuery name="ByExpressionLevel" includeProjects="ToxoDB,PlasmoDB,GiardiaDB"
              isCacheable="true">
        <paramRef ref="sageTagParams.st_min_count"/>
        <paramRef ref="sageTagParams.raw_normalized"/>
        <paramRef ref="sageTagParams.sage_experiment"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="tag_count" />
        <column name="tag_percentage" />
        <column name="raw_count" />
        <column name="raw_percentage" />
        <column name="SAGE_library" />
       <sql>
         <![CDATA[
         select distinct a.source_id, a.project_id,to_char(staa.tag_count, '99999') as tag_count, to_char(staa.raw_count , '99999') as raw_count,
         to_char(staa.library_tag_percentage,'990D00') || '%' as tag_percentage,
         to_char(staa.raw_percent,'990D00') || '%' as raw_percentage,
         staa.library_name as SAGE_library
         from apidb.SageTagAttributes a, apidb.SageTagAnalysisAttributes staa
         where (CASE '$$raw_normalized$$' WHEN 'n' THEN staa.tag_count ELSE staa.raw_count END)>= $$st_min_count$$ 
         and staa.library_name = $$sage_experiment$$
         and a.composite_element_id=staa.composite_element_id
         ]]>
       </sql>
</sqlQuery>

<processQuery name="ByExpressionLevel" includeProjects="EuPathDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">

       <paramRef ref="sageTagParams.st_min_count"/>
       <paramRef ref="sageTagParams.raw_normalized"/>
       <paramRef ref="sageTagParams.sage_experiment" quote="false"/>

       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>

       <wsColumn name="tag_count" width="32" wsName="tag_count" />
       <wsColumn name="tag_percentage" width="32" wsName="tag_percentage"/>
       <wsColumn name="raw_count" width="32" wsName="raw_count"/>
       <wsColumn name="raw_percentage" width="32" wsName="raw_percentage"/>
       <wsColumn name="SAGE_library" width="100" wsName="SAGE_library"/>
   </processQuery>

  </querySet>

</wdkModel>
