<wdkModel>
    <querySet name="SageTagAttributes" queryType="attribute" includeProjects="EuPathDB,PlasmoDB,ToxoDB,GiardiaDB">

             <defaultTestParamValues includeProjects="PlasmoDB">
               <paramValue name="source_id">Pf3D7_11-1295354-1295368.0</paramValue>
               <paramValue name="project_id">PlasmoDB</paramValue>
            </defaultTestParamValues>

            <defaultTestParamValues includeProjects="ToxoDB">
               <paramValue name="source_id">TGME49_chrII-1015856-1015870.1</paramValue>
               <paramValue name="project_id">ToxoDB</paramValue>
            </defaultTestParamValues>

            <defaultTestParamValues includeProjects="GiardiaDB">
               <paramValue name="source_id">CH991779-75398-75413.0</paramValue>
               <paramValue name="project_id">GiardiaDB</paramValue>
            </defaultTestParamValues>


            <testRowCountSql>
                select count(na_feature_id) from dots.SageTagFeature
            </testRowCountSql>

        <sqlQuery name="Attrs">
            <column name="project_id"/>
            <column name="source_id"/>
            <column name="tag_sequence"/> 
            <column name="sequence_id"/>
            <column name="start_min"  />
            <column name="end_max"  />
            <column name="is_reversed"/>
            <column name="strand"   sortingColumn="is_reversed"/>
            <column name="context_start"/>
            <column name="context_end"/>
            <column name="organism"  />
            <column name="rad_source_id"  />
            <column name="gene_source_id" />
            <column name="gene_product" />
            <column name="feature_source_id" />
            <sql>
            <![CDATA[
            select sta.project_id,
                   sta.source_id, 
                   CASE WHEN sta.sequence like 'CATG%' THEN sta.sequence ELSE 'CATG' || sta.sequence END as tag_sequence,
                   sta.sequence_source_id as sequence_id,
                   sta.start_min,
                   sta.end_max,
                   sta.is_reversed,
                   case when sta.is_reversed = 1 then '-' when sta.is_reversed = 0 then '+' else '.' end as strand,
                   sta.start_min - 5000 as context_start,
                   sta.end_max + 5000 as context_end,
                   sta.organism,
                   case when sta.rad_source_id is null then 'N/A' else sta.rad_source_id end as rad_source_id,
                   gene_source_id,
                   gene_product,
                   feature_source_id
            from apidb.SageTagAttributes sta
            ]]>
           </sql>
      </sqlQuery>


      <sqlQuery name="AlignmentCount">
            <column name="project_id"/>
            <column name="source_id"/>
            <column name="total_alignments"/>
            <sql>
            <![CDATA[
             select sta.source_id,'@PROJECT_ID@' as project_id,ct.total_alignments from (
               select composite_element_id, '@PROJECT_ID@' AS project_id, 
                    count(*) as total_alignments
               from apidb.SAGETAGATTRIBUTES 
               group by composite_element_id) ct, apidb.SAGETAGATTRIBUTES sta
             where sta.composite_element_id = ct.composite_element_id
            ]]>
           </sql>
      </sqlQuery>

      <sqlQuery name="GeneAlignmentCount">
            <column name="project_id"/>
            <column name="source_id"/>
            <column name="total_gene_alignments"/>
            <column name="local_gene_alignments"/>
            <sql>
            <![CDATA[
             select sta.source_id,'@PROJECT_ID@' as project_id, NVL(ct.total_gene_alignments,0) as total_gene_alignments,
                    sta.gene_count as local_gene_alignments from (
               select composite_element_id, '@PROJECT_ID@' AS project_id, 
                    count(*) as total_gene_alignments
               from apidb.SAGETAGATTRIBUTES 
                where gene_source_id is not null
               group by composite_element_id) ct, apidb.SAGETAGATTRIBUTES sta
             where sta.composite_element_id = ct.composite_element_id (+) 
            ]]>
           </sql>
      </sqlQuery>

 </querySet>

</wdkModel>
